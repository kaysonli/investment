define(['./helper/util'], function(util) {
    window.fundCallback = function(data) {
        var code = data.info.split('|')[0];
        window['fund_' + code] = data.info;
    };

    function getHistoricalValues(fundCode, year, callback) {
        var url = util.format('http://hqqd.fund123.cn/jsdata/nv_daily/{0}/{1}.js', year, fundCode);
        //daily_nv_020001_2014="20140102 0.9720 3.9760 5.491560 0.0031;20140103 0.9810 3.9850 5.542408 0.0093;20140106 0.9650 3.9690 5.452012 -0.0163;20140107 0.9730 3.9770 5.497210 0.0083;20140108 0.9890 3.9930 5.587606 0.0164;20140109 0.9880 3.9920 5.581956 -0.0010;20140110 0.9760 3.9800 5.514159 -0.0121;20140113 0.9800 3.9840 5.536758 0.0041;20140114 0.9990 4.0030 5.644103 0.0194;20140115 1.0020 4.0060 5.661053 0.0030;20140116 1.0000 4.0040 5.649753 
        util.loadScript(url, function() {
            var netValues = [],
                param = util.format('daily_nv_{0}_{1}', fundCode, year);
            if (window[param]) {
                var parts = window[param].split(';');
                for (var i = 0; i < parts.length; i++) {
                    var daily = parts[i].split(' ');
                    netValues.push({
                        date: daily[0],
                        value: daily[1],
                        change: daily[4]
                    });
                }
                if (callback) {
                    callback(netValues);
                }
            }
        });
    }

    function fixPlan() {
        var daily_nv_000051_2014 = "20140102 0.7010 0.7010 0.701000 -0.0028;20140103 0.6920 0.6920 0.692000 -0.0128;20140106 0.6770 0.6770 0.677000 -0.0217;20140107 0.6770 0.6770 0.677000 0.0000;20140108 0.6780 0.6780 0.678000 0.0015;20140109 0.6720 0.6720 0.672000 -0.0088;20140110 0.6670 0.6670 0.667000 -0.0074;20140113 0.6640 0.6640 0.664000 -0.0045;20140114 0.6690 0.6690 0.669000 0.0075;20140115 0.6680 0.6680 0.668000 -0.0015;20140116 0.6690 0.6690 0.669000 0.0015;20140117 0.6590 0.6590 0.659000 -0.0149;20140120 0.6560 0.6560 0.656000 -0.0046;20140121 0.6620 0.6620 0.662000 0.0091;20140122 0.6780 0.6780 0.678000 0.0242;20140123 0.6750 0.6750 0.675000 -0.0044;20140124 0.6790 0.6790 0.679000 0.0059;20140127 0.6710 0.6710 0.671000 -0.0118;20140128 0.6720 0.6720 0.672000 0.0015;20140129 0.6750 0.6750 0.675000 0.0045;20140130 0.6670 0.6670 0.667000 -0.0119;20140207 0.6700 0.6700 0.670000 0.0045;20140210 0.6860 0.6860 0.686000 0.0239;20140211 0.6910 0.6910 0.691000 0.0073;20140212 0.6930 0.6930 0.693000 0.0029;20140213 0.6890 0.6890 0.689000 -0.0058;20140214 0.6940 0.6940 0.694000 0.0073;20140217 0.6990 0.6990 0.699000 0.0072;20140218 0.6900 0.6900 0.690000 -0.0129;20140219 0.6980 0.6980 0.698000 0.0116;20140220 0.6920 0.6920 0.692000 -0.0086;20140221 0.6850 0.6850 0.685000 -0.0101;20140224 0.6710 0.6710 0.671000 -0.0204;20140225 0.6540 0.6540 0.654000 -0.0253;20140226 0.6560 0.6560 0.656000 0.0031;20140227 0.6530 0.6530 0.653000 -0.0046;20140228 0.6600 0.6600 0.660000 0.0107;20140303 0.6630 0.6630 0.663000 0.0045;20140304 0.6620 0.6620 0.662000 -0.0015;20140305 0.6560 0.6560 0.656000 -0.0091;20140306 0.6590 0.6590 0.659000 0.0046;20140307 0.6570 0.6570 0.657000 -0.0030;20140310 0.6360 0.6360 0.636000 -0.0320;20140311 0.6400 0.6400 0.640000 0.0063;20140312 0.6410 0.6410 0.641000 0.0016;20140313 0.6480 0.6480 0.648000 0.0109;20140314 0.6430 0.6430 0.643000 -0.0077;20140317 0.6500 0.6500 0.650000 0.0109;20140318 0.6480 0.6480 0.648000 -0.0031;20140319 0.6430 0.6430 0.643000 -0.0077;20140320 0.6340 0.6340 0.634000 -0.0140;20140321 0.6550 0.6550 0.655000 0.0331;20140324 0.6600 0.6600 0.660000 0.0076;20140325 0.6590 0.6590 0.659000 -0.0015;20140326 0.6580 0.6580 0.658000 -0.0015;20140327 0.6540 0.6540 0.654000 -0.0061;20140328 0.6530 0.6530 0.653000 -0.0015;20140331 0.6510 0.6510 0.651000 -0.0031;20140401 0.6560 0.6560 0.656000 0.0077;20140402 0.6610 0.6610 0.661000 0.0076;20140403 0.6570 0.6570 0.657000 -0.0061;20140404 0.6630 0.6630 0.663000 0.0091;20140408 0.6780 0.6780 0.678000 0.0226;20140409 0.6780 0.6780 0.678000 0.0000;20140410 0.6880 0.6880 0.688000 0.0147;20140411 0.6870 0.6870 0.687000 -0.0015;20140414 0.6860 0.6860 0.686000 -0.0015;20140415 0.6750 0.6750 0.675000 -0.0160;20140416 0.6760 0.6760 0.676000 0.0015;20140417 0.6740 0.6740 0.674000 -0.0030;20140418 0.6730 0.6730 0.673000 -0.0015;20140421 0.6630 0.6630 0.663000 -0.0149;20140422 0.6660 0.6660 0.666000 0.0045;20140423 0.6650 0.6650 0.665000 -0.0015;20140424 0.6640 0.6640 0.664000 -0.0015;20140425 0.6580 0.6580 0.658000 -0.0090;20140428 0.6480 0.6480 0.648000 -0.0152;20140429 0.6550 0.6550 0.655000 0.0108;20140430 0.6550 0.6550 0.655000 0.0000;20140505 0.6540 0.6540 0.654000 -0.0015;20140506 0.6540 0.6540 0.654000 0.0000;20140507 0.6490 0.6490 0.649000 -0.0076;20140508 0.6490 0.6490 0.649000 0.0000;20140509 0.6490 0.6490 0.649000 0.0000;20140512 0.6620 0.6620 0.662000 0.0200;20140513 0.6600 0.6600 0.660000 -0.0030;20140514 0.6600 0.6600 0.660000 0.0000;20140515 0.6520 0.6520 0.652000 -0.0121;20140516 0.6520 0.6520 0.652000 0.0000;20140519 0.6440 0.6440 0.644000 -0.0123;20140520 0.6440 0.6440 0.644000 0.0000;20140521 0.6500 0.6500 0.650000 0.0093;20140522 0.6480 0.6480 0.648000 -0.0031;20140523 0.6540 0.6540 0.654000 0.0093;20140526 0.6560 0.6560 0.656000 0.0031;20140527 0.6530 0.6530 0.653000 -0.0046;20140528 0.6600 0.6600 0.660000 0.0107;20140529 0.6560 0.6560 0.656000 -0.0061;20140530 0.6560 0.6560 0.656000 0.0000;20140603 0.6550 0.6550 0.655000 -0.0015;20140604 0.6480 0.6480 0.648000 -0.0107;20140605 0.6550 0.6550 0.655000 0.0108;20140606 0.6510 0.6510 0.651000 -0.0061;20140609 0.6510 0.6510 0.651000 0.0000;20140610 0.6590 0.6590 0.659000 0.0123;20140611 0.6590 0.6590 0.659000 0.0000;20140612 0.6570 0.6570 0.657000 -0.0030;20140613 0.6630 0.6630 0.663000 0.0091;20140616 0.6680 0.6680 0.668000 0.0075;20140617 0.6620 0.6620 0.662000 -0.0090;20140618 0.6600 0.6600 0.660000 -0.0030;20140619 0.6500 0.6500 0.650000 -0.0152;20140620 0.6530 0.6530 0.653000 0.0046;20140623 0.6530 0.6530 0.653000 0.0000;20140624 0.6570 0.6570 0.657000 0.0061;20140625 0.6540 0.6540 0.654000 -0.0046;20140626 0.6590 0.6590 0.659000 0.0076;20140627 0.6600 0.6600 0.660000 0.0015;20140630 0.6640 0.6640 0.664000 0.0061;20140701 0.6640 0.6640 0.664000 0.0000;20140702 0.6660 0.6660 0.666000 0.0030;20140703 0.6690 0.6690 0.669000 0.0045;20140704 0.6690 0.6690 0.669000 0.0000;20140707 0.6680 0.6680 0.668000 -0.0015;20140708 0.6700 0.6700 0.670000 0.0030;20140709 0.6610 0.6610 0.661000 -0.0134;20140710 0.6600 0.6600 0.660000 -0.0015;20140711 0.6630 0.6630 0.663000 0.0045;20140714 0.6700 0.6700 0.670000 0.0106;20140715 0.6710 0.6710 0.671000 0.0015;20140716 0.6700 0.6700 0.670000 -0.0015;20140717 0.6670 0.6670 0.667000 -0.0045;20140718 0.6700 0.6700 0.670000 0.0045;20140721 0.6700 0.6700 0.670000 0.0000;20140722 0.6780 0.6780 0.678000 0.0119;20140723 0.6800 0.6800 0.680000 0.0029;20140724 0.6910 0.6910 0.691000 0.0162;20140725 0.6980 0.6980 0.698000 0.0101;20140728 0.7170 0.7170 0.717000 0.0272;20140729 0.7190 0.7190 0.719000 0.0028;20140730 0.7170 0.7170 0.717000 -0.0028;20140731 0.7250 0.7250 0.725000 0.0112;20140801 0.7190 0.7190 0.719000 -0.0083;20140804 0.7320 0.7320 0.732000 0.0181;20140805 0.7310 0.7310 0.731000 -0.0014;20140806 0.7290 0.7290 0.729000 -0.0027;20140807 0.7190 0.7190 0.719000 -0.0137;20140808 0.7200 0.7200 0.720000 0.0014;20140811 0.7300 0.7300 0.730000 0.0139;20140812 0.7280 0.7280 0.728000 -0.0027;20140813 0.7280 0.7280 0.728000 0.0000;20140814 0.7210 0.7210 0.721000 -0.0096;20140815 0.7290 0.7290 0.729000 0.0111;20140818 0.7330 0.7330 0.733000 0.0055;20140819 0.7330 0.7330 0.733000 0.0000;20140820 0.7310 0.7310 0.731000 -0.0027;20140821 0.7270 0.7270 0.727000 -0.0055;20140822 0.7310 0.7310 0.731000 0.0055;20140825 0.7240 0.7240 0.724000 -0.0096;20140826 0.7180 0.7180 0.718000 -0.0083;20140827 0.7190 0.7190 0.719000 0.0014;20140828 0.7150 0.7150 0.715000 -0.0056;20140829 0.7220 0.7220 0.722000 0.0098;20140901 0.7270 0.7270 0.727000 0.0069;20140902 0.7360 0.7360 0.736000 0.0124;20140903 0.7430 0.7430 0.743000 0.0095;20140904 0.7480 0.7480 0.748000 0.0067;20140905 0.7550 0.7550 0.755000 0.0094;20140909 0.7540 0.7540 0.754000 -0.0013;20140910 0.7500 0.7500 0.750000 -0.0053;20140911 0.7470 0.7470 0.747000 -0.0040;20140912 0.7520 0.7520 0.752000 0.0067;20140915 0.7520 0.7520 0.752000 0.0000;20140916 0.7380 0.7380 0.738000 -0.0186;20140917 0.7410 0.7410 0.741000 0.0041;20140918 0.7430 0.7430 0.743000 0.0027;20140919 0.7480 0.7480 0.748000 0.0067;20140922 0.7350 0.7350 0.735000 -0.0174;20140923 0.7410 0.7410 0.741000 0.0082;20140924 0.7530 0.7530 0.753000 0.0162;20140925 0.7520 0.7520 0.752000 -0.0013;20140926 0.7520 0.7520 0.752000 0.0000;20140929 0.7550 0.7550 0.755000 0.0040;20140930 0.7560 0.7560 0.756000 0.0013;20141008 0.7640 0.7640 0.764000 0.0106;20141009 0.7650 0.7650 0.765000 0.0013;20141010 0.7610 0.7610 0.761000 -0.0052;20141013 0.7570 0.7570 0.757000 -0.0053;20141014 0.7550 0.7550 0.755000 -0.0026;20141015 0.7600 0.7600 0.760000 0.0066;20141016 0.7540 0.7540 0.754000 -0.0079;20141017 0.7530 0.7530 0.753000 -0.0013;20141020 0.7570 0.7570 0.757000 0.0053;20141021 0.7510 0.7510 0.751000 -0.0079;20141022 0.7470 0.7470 0.747000 -0.0053;20141023 0.7400 0.7400 0.740000 -0.0094;20141024 0.7390 0.7390 0.739000 -0.0014;20141027 0.7320 0.7320 0.732000 -0.0095;20141028 0.7460 0.7460 0.746000 0.0191;20141029 0.7560 0.7560 0.756000 0.0134;20141030 0.7610 0.7610 0.761000 0.0066;20141031 0.7730 0.7730 0.773000 0.0158;20141103 0.7740 0.7740 0.774000 0.0013;20141104 0.7740 0.7740 0.774000 0.0000;20141105 0.7720 0.7720 0.772000 -0.0026;20141106 0.7730 0.7730 0.773000 0.0013;20141107 0.7710 0.7710 0.771000 -0.0026;20141110 0.7900 0.7900 0.790000 0.0246;20141111 0.7880 0.7880 0.788000 -0.0025;20141112 0.7970 0.7970 0.797000 0.0114;20141113 0.7930 0.7930 0.793000 -0.0050;20141114 0.7930 0.7930 0.793000 0.0000;20141117 0.7900 0.7900 0.790000 -0.0038;20141118 0.7820 0.7820 0.782000 -0.0101;20141119 0.7810 0.7810 0.781000 -0.0013;20141120 0.7810 0.7810 0.781000 0.0000;20141121 0.7950 0.7950 0.795000 0.0179;20141124 0.8140 0.8140 0.814000 0.0239;20141125 0.8240 0.8240 0.824000 0.0123;20141126 0.8350 0.8350 0.835000 0.0133;20141127 0.8440 0.8440 0.844000 0.0108;20141128 0.8600 0.8600 0.860000 0.0190;20141201 0.8630 0.8630 0.863000 0.0035;20141202 0.8920 0.8920 0.892000 0.0336;20141203 0.9050 0.9050 0.905000 0.0146;20141204 0.9420 0.9420 0.942000 0.0409;20141205 0.9470 0.9470 0.947000 0.0053;20141208 0.9820 0.9820 0.982000 0.0370;20141209 0.9410 0.9410 0.941000 -0.0418;20141210 0.9720 0.9720 0.972000 0.0329;20141211 0.9630 0.9630 0.963000 -0.0093;20141212 0.9660 0.9660 0.966000 0.0031;20141215 0.9720 0.9720 0.972000 0.0062;20141216 0.9960 0.9960 0.996000 0.0247;20141217 1.0100 1.0100 1.010000 0.0141;20141218 1.0050 1.0050 1.005000 -0.0050;20141219 1.0150 1.0150 1.015000 0.0100;20141222 1.0200 1.0200 1.020000 0.0049;20141223 1.0000 1.0000 1.000000 -0.0196;20141224 0.9750 0.9750 0.975000 -0.0250;20141225 1.0050 1.0050 1.005000 0.0308;";
        var netValues = daily_nv_000051_2014.split(';');
        var amount = 1000,
            invest = 0,
            shares = 0;
        var prevRate = 0;
        for (var i = 0; i < netValues.length; i++) {
            if (netValues[i] == '') continue;
            var parts = netValues[i].split(' '),
                nv = parts[1],
                date = parts[0],
                rate = parts[4];
            if (rate < 0 && prevRate < 0) {
                shares += amount / nv;
                invest += amount;
            }
            prevRate = rate;
        }
        console.log(shares, nv, shares * nv, (shares * nv - invest) / invest);
    }

    function filter(data, method) {
        var parts = data.split(' '),
            date = parts[0],
            nv = parts[1],
            rate = parts[4];
        if (method == 'fixed') {
            var month = date.substr(6);
        }
    }

    var FundDTSY = {
        result: function(data) {
            console.log(data);
        }
    };

    function optimalInvest(netValues, config) {

    }
    return {
        getList: function(callback) {
            var url = 'http://hqqd.fund123.cn/funddataforsearch.js?ver=' + (+new Date);
            util.loadScript(url, function() {
                var fundList = [],
                    openList = [],
                    currencyList = [];
                if (fundArray) {
                    for (var i = fundArray.length - 1; i >= 0; i--) {
                        var fund = fundArray[i];
                        //['泰信中小盘精选股票','290011','txzxpjxgp','0']
                        fundList.push({
                            name: fund[0],
                            code: fund[1]
                        });
                    }
                    for (var i = fundArray_Open.length - 1; i >= 0; i--) {
                        var fund = fundArray_Open[i];
                        openList.push({
                            name: fund[0],
                            code: fund[1]
                        });
                    }
                    for (var i = fundArray_Currency.length - 1; i >= 0; i--) {
                        var fund = fundArray_Currency[i];
                        currencyList.push({
                            name: fund[0],
                            code: fund[1]
                        });
                    }
                    if (callback) {
                        callback(fundList, openList, currencyList);
                    }
                }
            });
        },
        getHistoricalValues: getHistoricalValues,

        getEstimatedValues: function() {

        },

        optimalInvest: function(fundCode) {

        },

        fixedInvest: function(config) {
            var fundCode = config.fundCode,
                startDate = config.startDate,
                endDate = config.endDate,
                redeemDate = config.redeemDate,
                round = config.round || 1, // round = 1 * months or -7 * weeks
                fixedDay = config.fixedDay || 1,
                fee = config.fee || 0.6,
                amount = config.fee,
                dividendType = config.dividendType || 2, //1: 红利再投资，2：现金分红
                needfirst = config.needfirst ? 1 : 2,
                jsoncallback = 'fundCallback';
            var tpl = 'http://fund.eastmoney.com/data/FundInvestCaculator_AIPDatas.aspx?fcode={0}&sdate={1}&edate={2}&shdate={3}&round={4}&dtr={5}&p={6}&je={7}&stype={8}&needfirst={9}&jsoncallback={10}';
            var url = util.format(tpl, fundCode, startDate, endDate, redeemDate, round, fixedDay, fee, amount, dividendType, needfirst, jsoncallback);
            util.loadScript(url, function() {
                if (config.callback) {
                    var result = window['fund_' + config.fundCode];
                    config.callback(result.split('|')[6]);
                }
            });
        }
    };
});
